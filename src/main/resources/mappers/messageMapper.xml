<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community.hojun.MessagesMapper">

<select id="getReceiveMessageList" resultType="com.community.hojun.MessageResponse" useCache="false">
    SELECT
        M.ID as id,
        M.TITLE as title,
        M.CONTENT as content,
        M.SENDER_ID as senderId,
        M.RECEIVER_ID as receiverId,
        S.NICKNAME as senderName,
        R.NICKNAME as receiverName,
        M.IS_READ as isRead,
        M.DELETED_BY_SENDER as deletedBySender,
        M.DELETED_BY_RECEIVER as deletedByReceiver,
        M.CREATED_AT as createdAt
    FROM MESSAGES M
    INNER JOIN USERS S ON M.SENDER_ID = S.ID
    INNER JOIN USERS R ON M.RECEIVER_ID = R.ID
    WHERE M.DELETED_BY_RECEIVER = 0
    AND M.RECEIVER_ID = #{param1}
    ORDER BY M.ID DESC
</select>

<select id="getSentMessageList" resultType="com.community.hojun.MessageResponse" useCache="false">
    SELECT
        M.ID as id,
        M.TITLE as title,
        M.CONTENT as content,
        M.SENDER_ID as senderId,
        M.RECEIVER_ID as receiverId,
        S.NICKNAME as senderName,
        R.NICKNAME as receiverName,
        M.IS_READ as isRead,
        M.DELETED_BY_SENDER as deletedBySender,
        M.DELETED_BY_RECEIVER as deletedByReceiver,
        M.CREATED_AT as createdAt
    FROM MESSAGES M
    INNER JOIN USERS S ON M.SENDER_ID = S.ID
    INNER JOIN USERS R ON M.RECEIVER_ID = R.ID
    WHERE M.DELETED_BY_SENDER = 0
    AND M.SENDER_ID = #{param1}
    ORDER BY M.ID DESC
</select>

<select id="getMessage" resultType="com.community.hojun.MessageDTO">
    SELECT
        ID as id,
        TITLE as title,
        CONTENT as content,
        SENDER_ID as sender_id,
        RECEIVER_ID as receiver_id,
        IS_READ as is_read,
        DELETED_BY_SENDER as deleted_by_sender,
        DELETED_BY_RECEIVER as deleted_by_receiver,
        CREATED_AT as created_at,
        READ_AT as read_at
    FROM MESSAGES
    WHERE ID = #{param1}
</select>

<insert id="sendMessage">
    INSERT INTO MESSAGES (
        TITLE,
        CONTENT,
        SENDER_ID,
        RECEIVER_ID
    ) VALUES (
        #{title},
        #{content},
        #{sender_id},
        #{receiver_id}
    )
</insert>

<update id="updateIsRead" flushCache="true">
    UPDATE MESSAGES
    SET IS_READ = 1,
        READ_AT = CURRENT_TIMESTAMP
    WHERE ID = #{param1}
</update>

<update id="receiverDeleteMessage" flushCache="true">
    UPDATE MESSAGES
    SET DELETED_BY_RECEIVER = 1
    WHERE ID = #{param1}
</update>

<update id="senderDeleteMessage" flushCache="true">
    UPDATE MESSAGES
    SET DELETED_BY_SENDER = 1
    WHERE ID = #{param1}
</update>

<select id="getUnreadMessageCount" resultType="int" useCache="false">
    SELECT COUNT(*)
    FROM MESSAGES
    WHERE RECEIVER_ID = #{param1}
    AND IS_READ = 0
    AND DELETED_BY_RECEIVER = 0
</select>

</mapper>